#!/bin/bash

#----------------------------------------------------------------------------------------------
function registryReport.usage()
{
    local -i exit_status=${1:-1}

    cat >&2 << EOF
Usage:
    $progname [ -h|--help ] |
              [ --catalog ] |
              [ --format <json|text> ] |
              [ --output <filename> ]
              <repository> | <repository> | <repository>

    Common options:
        -h --help                 Display a basic set of usage instructions
        -c --catalog              dump the registry catalog (as json)
        -f --format <json|text>   format output as JSON|TEXT
        -o --output <filename>    name of file to output

    Report the contents of the name docker repository from the registry, if no repositories are name, all are reported
    The name of the docker registry should not be included in the repository name.
    One or more repository may be specified. regex expressions are permitted to define the repository names.

EOF

    exit "$exit_status"
}

#----------------------------------------------------------------------------------------------
function registryReport.cmdLineArgs()
{
    local usage='registryReport.usage'

    # Parse command-line options into above variable
    local -r progname="$( basename "${BASH_SOURCE[0]}" )"
    local -r options=$(getopt --longoptions "help,Help,HELP,catalog,format:,output:" --options "Hhcf:o:" --name "$progname" -- "$@") || "$usage" $?
    eval set -- "$options"

    local -A opts=( ['format']='json' )
    while true; do
        case "${1:-}" in
            -h|--h|--help|-help)  "$usage" 1;;
            -H|--H|--HELP|-HELP)  "$usage" 1;;
            --Help|-Help)         "$usage" 1;;
            -c|--c|--catalog)     opts['catalog']=1; shift;;
            -f|--f|--format)      opts['format']=$2; shift 2;;
            -o|--o|--output)      opts['output']="$2"; shift 2;;
            --)                 shift; break;;
        esac
    done
    
    appenv.results "$@"
}

#----------------------------------------------------------------------------------------------
function registryReport.formatTextReport()
{
    local -r TOOLS="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )" 

    docker run --rm \
               --volume "$TOOLS":/home/groovy/scripts \
               --volume "/tmp:/tmp" \
               -e "JSON=/tmp/reportCatalog.json" \
               --workdir /home/groovy/scripts \
               "$(registry.SERVER)alpine/groovy:2.6-jre" \
               groovy registryReport.groovy  
}

#----------------------------------------------------------------------------------------------
function registryReport.reportCatalogAsJson()
{
    local -a catalog=( "$@" )
    [ "${#catalog[*]}" -gt 0 ] || catalog=( '.+' )

    if [ '' ]; then
        local tmpfile="$(mktemp)"
        printf '%s\n' "${catalog[@]}" > "$tmpfile"
        mapfile -t catalog < <(registry.catalog | grep -E -f "$tmpfile" ||:) # ignore errors
        rm "$tmpfile"
    else
        mapfile -t catalog < <(registry.catalog | grep -E -f <(printf '%s\n' "${catalog[@]}") | sort ||:)
    fi

    if [ "${#catalog[*]}" -gt 0 ]; then
        echo -n '['
        local -i index=0
        for entry in "${catalog[@]}"; do
            (( index++ )) && echo -n ','

            local digests="$(registry.digests "$entry")"
            printf '{"id":"%05d","repository":"%s"' "$index" "$entry"
            [ -z "$digests" ] || echo -n ',"digests":['"${digests}]"
            echo -n '}'
        done
        echo -n ']'
    else
        term.elog 'No content specified' 'warn'
    fi
}

#----------------------------------------------------------------------------------------------
function registryReport.reportCatalog()
{
    local -A opts
    eval opts=( ${1:?} )
    readonly opts
    [ $# -gt 0 ] && shift

    if [ "${opts['catalog']:-}" ]; then
        registry.catalog

    elif [ "${opts['format']}" = 'json' ]; then
        if [ "${opts['output']:-}" ]; then
            registryReport.reportCatalogAsJson "$@" > "${opts['output']}"
        else
            registryReport.reportCatalogAsJson "$@"
        fi

    else
        registryReport.reportCatalogAsJson "$@" > /tmp/reportCatalog.json
        if registryReport.formatTextReport /tmp/reportCatalog.json ;then
            if [ "${opts['output']:-}" ]; then
                mv ./registryReport.txt "${opts['output']}"
            else
                cat ./registryReport.txt
                rm ./registryReport.txt
           fi
        fi
    fi
    [ ! -e /tmp/reportCatalog.json ] || rm /tmp/reportCatalog.json
}

#----------------------------------------------------------------------------------------------

declare -i status
declare -a args

declare loader="$(dirname "${BASH_SOURCE[0]}")/libs/appenv.bashlib"
if [ ! -e "$loader" ]; then
    echo 'Unable to load libraries'
    exit 1
fi
source "$loader"
appenv.loader 'registry.reportCatalogAsJson'
args=( $( registryReport.cmdLineArgs "$@" ) ) && status=$? || status=$?
[ $status -eq 0 ] && registryReport.reportCatalog ${args[@]}
